# Схемы электропитания Power Manager

Три схемы электропитания Windows настраиваются скриптами и переключаются из виджета или из консоли. Ниже — что делают схемы, порядок настройки и связь с виджетом.

**Быстрый старт:** см. [GETTING-STARTED.md](GETTING-STARTED.md) (от установки схем до запуска виджета).

## 1. Что делают схемы

| Схема | CPU макс | CPU мин | Энергосбережение | Подсветка клавиатуры |
|-------|----------|---------|------------------|----------------------|
| **Минимум** | 50% | 5% | Макс. (PCIe, диск, сон, охлаждение пассивное) | Выключена (вручную) |
| **Сбалансированный** | 90% | 5% | Как стандартный баланс Windows | По умолчанию |
| **Максимум** | 100% | 20% (AC) / 10% (DC) | Выключены (PCIe Off, активное охлаждение, boost) | На всю (вручную) |

Яркость экрана при переключении схем **не меняется** — настраивайте вручную или через виджет. Подсветка клавиатуры на Dell не управляется через powercfg — переключается вручную (Fn+F10 или Dell Quickset).

## 2. Порядок действий

### Шаг 1: Просмотр текущих схем

```powershell
cd C:\Users\AI_Art\power_manager
.\scripts\List-PowerSchemes.ps1
```

### Шаг 2: Создание трёх схем и запись GUID

Запуск **от имени администратора** желателен.

```powershell
.\scripts\Install-PowerManagerSchemes.ps1
```

- Скрипт **удаляет** предыдущие три схемы Power Manager (по GUID из `scheme-guids.json`), затем создаёт три новые — так не копится по 6–9 схем.
- Имена и описания задаются **только латиницей** (английский), чтобы в интерфейсе не было кракозябр.
- У каждой схемы своё **описание** (второй абзац в списке планов): Minimum — про 50% CPU и энергосбережение, Balanced — про 90% и баланс, Maximum — про 100% и максимальную производительность.

В корне проекта появится (или обновится) `scheme-guids.json` с GUID схем Min, Balanced, Max.

Скрипт **сам удаляет** все остальные схемы электропитания (дубликаты «Сбалансированная», «Super Maximum Performance» и т.п.), оставляя только три схемы Power Manager и системный шаблон «Сбалансированная» (381b4222-…). Шаблон нужен для повторного запуска скрипта; при желании его можно удалить вручную в «Электропитание», тогда останутся только три схемы.

### Шаг 3: Переключение схемы

Скрипт меняет **только** схему электропитания; яркость экрана не изменяется.

```powershell
.\scripts\Apply-PowerScheme.ps1 -Scheme Min
.\scripts\Apply-PowerScheme.ps1 -Scheme Balanced
.\scripts\Apply-PowerScheme.ps1 -Scheme Max
```

### Шаг 4: Виджет на рабочем столе

Приложение **PowerManagerWidget** — полупрозрачная панель в стиле диспетчера задач: графики частоты CPU, загрузки и максимальной температуры (самая горячая точка по всем датчикам) и круглые кнопки выбора схемы (батарейка / весы / молния).

**Где искать окно:** виджет открывается **отдельным окном** поверх рабочего стола (по умолчанию ближе к левому верхнему углу, можно перетаскивать). Окно без рамки, тёмная панель с графиками.

Запуск из корня проекта:

```powershell
dotnet run --project src\PowerManagerWidget\PowerManagerWidget.csproj
```

Или запустите **PowerManagerWidget.exe** из папки:

```
src\PowerManagerWidget\bin\Debug\net8.0-windows\PowerManagerWidget.exe
```

Рядом с exe должен лежать файл **scheme-guids.json** (он копируется при сборке из корня проекта). Если окно не появляется, при следующем запуске может появиться сообщение об ошибке — по нему можно понять причину (например, не найден scheme-guids.json или ошибка доступа к датчикам). Для доступа к температуре CPU желательно запускать **от имени администратора**.

**Связь с виджетом:** виджет читает `scheme-guids.json` при старте и переключает схемы по кнопкам (Минимум / Сбалансированная / Максимум) и в режиме «Авто». Файл должен быть создан скриптом `Install-PowerManagerSchemes.ps1` до первого запуска виджета.

### Шаг 5: Тест схем (опционально, 5–10 прогонов на схему, нагрузка CPU+RAM)

Сначала создайте схемы (шаг 2). Затем из корня проекта:

```powershell
dotnet run --project src\PowerSchemeTest\PowerSchemeTest.csproj
```

По умолчанию: 5 прогонов на схему, 30 с нагрузкой за прогон. Аргументы: `[прогонов] [секунд_нагрузки]`.

Пример: 10 прогонов, 45 с нагрузкой:

```powershell
dotnet run --project src\PowerSchemeTest\PowerSchemeTest.csproj 10 45
```

Результаты пишутся в `PowerSchemeTest-Results.csv` (Scheme, Run, MaxTempC, AvgTempC, AvgLoadPct, Samples).

## 3. Параметры powercfg, которые трогаем

- **Процессор:** макс./мин. состояние (PROCTHROTTLEMAX/MIN), политика охлаждения (SYSCOOLPOL), режим boost (PERFBOOSTMODE).
- **Экран:** яркость (VIDEONORMALLEVEL в SUB_VIDEO).
- **PCI Express:** управление питанием ссылки (ASPM) — Off / Moderate / Max power savings.
- **Сон:** таймауты перехода в сон (STANDBYIDLE).
- **Диск:** отключение диска через (DISKIDLE).

Полный список GUID — в [Known Windows Power GUIDs](https://bitsum.com/known-windows-power-guids/) и в `powercfg /query`.

## 4. Реестр и политики

- Схемы и их параметры хранятся в `HKLM\SYSTEM\CurrentControlSet\Control\Power\PowerSettings` и в `HKLM\SYSTEM\CurrentControlSet\Control\Power\User\PowerSchemes`.
- Изменения через `powercfg` автоматически пишутся в реестр; править вручную не обязательно.
- Групповые политики электропитания: `Компьютер → Администрирование → Электропитание`. Если политика задаёт схему по умолчанию или блокирует изменение схем, скрипты могут не переключить активную схему — тогда нужно ослабить или изменить политику.
- Скрытые параметры (например, часть процессорных) можно включить в реестре, сняв атрибут `Attributes` для нужного GUID в `PowerSettings`, после чего они появятся в `powercfg /query` и в настройках электропитания.

## 5. Ограничения

- **Яркость по WMI** работает только для встроенной панели, поддерживающей WmiMonitorBrightnessMethods; внешние мониторы обычно не меняются.
- **Подсветка клавиатуры** на Dell не управляется стандартным API — только вручную или через Dell ПО.
- На процессорах Intel с P- и E-ядрами «макс. состояние процессора» в Windows может ограничивать в основном E-ядра; P-ядра могут вести себя иначе (зависит от драйвера и прошивки).
